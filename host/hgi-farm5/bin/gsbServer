#!/bin/bash

if [ "$(hostname)" != "hgi-farm5" ]; then
	echo "This script should only be run on hgi-farm5!" >&2;

	exit 1;
fi;

export WR_CONFIG_DIR=/nfs/hgi/wr/openstack;
source /hgi/secrets/mercury-theta-hgi-dev-openrc.sh;

declare WR_PID="";
declare SOFTPACK_CONFIG=~/.softpack/builder/gsb-config.yml;
declare GSBBASE="/nfs/hgi/softpack/gsb/";
declare PIDFILE="$GSBBASE/pid";
declare LOGOUT="$GSBBASE/log.out";
declare LOGERR="$GSBBASE/log.err";

start() {
	if [ ! -f "$SOFTPACK_CONFIG" ]; then
		echo "SoftPack Builder Configuration File Missing!" >&2;

		exit 1;
	fi;

	/software/hgi/installs/wr/wr status --deployment production &> /dev/null || {
		echo "Starting WR in OpenStack...";

		/software/hgi/installs/wr/wr cloud deploy --manager_flavor m2.medium;
	}

	if [ -e "$PIDFILE" ]; then
		ps -P "$(cat "$PIDFILE")" &> /dev/null && {
			echo "GSB Already Running";

			exit 0;
		}
	fi;

	echo "Starting GSB Server...";

	export PATH="/software/hgi/installs/wr/";
	/software/hgi/installs/daemonize/daemonize -p "$PIDFILE" -a -e "$LOGERR" -o "$LOGOUT" /software/hgi/installs/softpack/gsb-build/gsb server;

	echo "...Done";
}

stop() {
	if [ -e "$PIDFILE" ]; then
		declare PID="$(cat "$PIDFILE")";
		ps -P "$PID" &> /dev/null && {
			kill "$PID" && echo "GSB Stopped" || echo "GSB  could not be stopped";

			exit 0;
		}
	fi;

	echo "GSB Not Running";
}

fullstop() {
	/software/hgi/installs/wr/wr status --deployment production &> /dev/null && {
		echo "Stopping WR in OpenStack...";

		wr cloud teardown

		echo "...Done";
	}

	stop;
}

buildlog() {
	echo -n "Enter environment path: "
	read envpath;
	echo -n "Enter environment version: ";
	read version;

	{
		s3cmd get "s3://spack/builds/$envpath/$version/builder.out" - 2> /dev/null ||
		echo "Build log not found";
	} | less +G
}

case "${1:-}" in
"start") start;;
"stop") stop;;
"fullstop") fullstop;;
"buildlog") buildlog;;
"logout") less +G "$LOGOUT";;
"logerr") less +G "$LOGERR";;
*)
	cat <<HEREDOC
Usage: $0 start|stop|fullstop|logout|logerr

Subcommand
  start     Start GSB.
  stop      Stop GSB.
  fullstop  Stop GSB and WR cloud deployment.
  buildlog  Show the build log for an environment.
  logout    Show the standard output log (useful for debugging).
  logerr    Show the standard error log (useful for debugging).
HEREDOC
esac;
